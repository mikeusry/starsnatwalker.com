# Tracking Library

Analytics and tracking functionality for Stars National Walker recruiting platform.

## Files

- [`tracking.ts`](./tracking.ts) - pd-pixel integration and event tracking

## pd-pixel Integration

The pd-pixel tracking system monitors college coach engagement with player profiles to provide recruiting intelligence.

### What It Tracks

**Automatically tracked events:**
- **Player profile views** - When someone visits `/players/[slug]`
- **Video views** - When highlight videos are played
- **Contact clicks** - When coaches click email/phone links
- **Referrer data** - Where traffic came from (organic, campaigns, .edu domains)
- **Attribution** - UTM parameters from marketing campaigns
- **Device fingerprinting** - Cross-session visitor identification
- **Geographic data** - Country/region (enriched server-side)

### Events Tracked

```typescript
// Player profile view
{
  event: 'player_profile_view',
  player_id: 'uuid',
  player_name: 'First Last',
  grad_year: '2027',
  position: 'SS'
}

// Video view
{
  event: 'player_video_viewed',
  player_id: 'uuid',
  player_name: 'First Last'
}

// Contact click
{
  event: 'player_contact_click',
  player_id: 'uuid',
  contact_type: 'email' | 'phone'
}
```

### How It Works

1. **Client-side pixel** loads on every page (`pd-pixel.min.js`)
2. **Event tracking** fires on page views, video plays, clicks
3. **Data collection** sends events to Program Match API
4. **Server enrichment** adds IP geolocation, user agent parsing
5. **Database storage** in `pixel_events` table
6. **Weekly reports** sent to recruiting coordinator

### Viewing Analytics

Analytics are viewed in the Program Match admin dashboard:

```
https://program-match.com/admin/analytics
```

**Available reports:**
- Total views per player
- Top viewed players
- Geographic breakdown
- Coach identification (.edu domains)
- Referrer sources
- Attribution by campaign

### Privacy & GDPR Compliance

**What we collect:**
- Anonymous visitor IDs (first-party cookie)
- Device fingerprint (browser characteristics)
- IP address (hashed for privacy)
- Page views and interactions

**What we DON'T collect:**
- Personal identifying information
- Names or emails (unless voluntarily submitted)
- Sensitive personal data

**Compliance measures:**
- IP addresses are SHA-256 hashed before storage
- Data retention: 90 days for raw events
- Right to deletion: Contact mike@point.dog
- Cookie notice on site footer

### Integration

The pixel is automatically loaded in [`src/layouts/Layout.astro`](../layouts/Layout.astro) and tracking functions are called in player profile pages.

No manual integration needed for new pages - tracking happens automatically.

### Troubleshooting

**Pixel not loading:**
- Check browser console for errors
- Verify `/js/pd-pixel.min.js` is accessible
- Check ad blockers aren't blocking the script

**Events not appearing:**
- Check Network tab for POST to `/api/pixel/collect`
- Verify Program Match API is running
- Check browser console for tracking errors

**False positives:**
- Bot traffic is filtered server-side
- Dev/test traffic excluded via `localhost` detection

### Development

When developing locally, set `debug: true` in pixel config:

```javascript
window.pdPixelConfig = {
  brandId: 'starsnatwalker',
  endpoint: 'http://localhost:3000/api/pixel/collect',
  debug: true // Enables console logging
};
```

This will log all tracking events to the browser console without sending to production.

## Weekly Reports

Automated reports are sent every Monday at 9am UTC to `mike@point.dog` with:
- Total profile views
- Top 5 viewed players
- Geographic breakdown
- Identified coach views (.edu domains)

Reports are generated by the Program Match cron job.
